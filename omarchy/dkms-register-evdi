#!/usr/bin/env bash
#dkms-register-evdi
set -euo pipefail

KVER="$(uname -r)"
EVDI_SRC="/tmp/evdi"

echo "ğŸ§© Removing any stale DKMS registration..."
sudo dkms remove evdi/1.9.1 --all 2>/dev/null || true

echo "ğŸ§© Cloning master branch (upstream latest)..."
sudo rm -rf "$EVDI_SRC"
sudo git clone --depth=1 https://github.com/DisplayLink/evdi.git "$EVDI_SRC"

echo "ğŸ§© Building module from source..."
cd "$EVDI_SRC/module"
sudo make clean || true
sudo make CFLAGS=-Wno-error

echo "ğŸ§© Installing module into kernel tree..."
sudo make -C /lib/modules/$(uname -r)/build M="$EVDI_SRC/module" modules_install

echo "ğŸ§© Refreshing kernel modules..."
sudo depmod -a
sudo modprobe -r evdi 2>/dev/null || true
sudo modprobe evdi

if lsmod | grep -q '^evdi'; then
  echo "âœ… EVDI module loaded and active."
  echo "evdi" | sudo tee /etc/modules-load.d/evdi.conf >/dev/null
  sudo systemctl daemon-reload
  echo "âœ… Autoload rule ensured â†’ /etc/modules-load.d/evdi.conf"
else
  echo "âŒ EVDI still not loaded."
fi

echo "ğŸ dkms-register-evdi script completed."
