#!/usr/bin/env bash
#dkms-register-evdi
set -euo pipefail

KVER="$(uname -r)"
EVDI_SRC="/tmp/evdi"

echo "🧩 Removing any stale DKMS registration..."
sudo dkms remove evdi/1.9.1 --all 2>/dev/null || true

echo "🧩 Cloning master branch (upstream latest)..."
sudo rm -rf "$EVDI_SRC"
sudo git clone --depth=1 https://github.com/DisplayLink/evdi.git "$EVDI_SRC"

echo "🧩 Building module from source..."
cd "$EVDI_SRC/module"
sudo make clean || true
sudo make CFLAGS=-Wno-error

echo "🧩 Installing module into kernel tree..."
sudo make -C /lib/modules/$(uname -r)/build M="$EVDI_SRC/module" modules_install

echo "🧩 Refreshing kernel modules..."
sudo depmod -a
sudo modprobe -r evdi 2>/dev/null || true
sudo modprobe evdi

if lsmod | grep -q '^evdi'; then
  echo "✅ EVDI module loaded and active."
  echo "evdi" | sudo tee /etc/modules-load.d/evdi.conf >/dev/null
  sudo systemctl daemon-reload
  echo "✅ Autoload rule ensured → /etc/modules-load.d/evdi.conf"
else
  echo "❌ EVDI still not loaded."
fi

echo "🏁 dkms-register-evdi script completed."
