#!/usr/bin/env bash
# test-thinkpad ‚Äî Comprehensive ThinkPad validation after migration or reboot
set -euo pipefail

source ./functions
source ./config

# ---------------------------------------------------------------------------
# 1. Logging setup
# ---------------------------------------------------------------------------
log_bar
say "üß† ThinkPad Validation Test ‚Äî $(date)"
log_bar

# ---------------------------------------------------------------------------
# 2. Environment information
# ---------------------------------------------------------------------------
log_info "System Information"
uname -a
echo "User: $(whoami)"
echo "Hostname: $(hostname)"
echo "Kernel: $(uname -r)"
echo "Uptime: $(uptime -p)"
echo

# ---------------------------------------------------------------------------
# 3. Network check
# ---------------------------------------------------------------------------
log_info "Network Interfaces"
ip link show | grep -E '^[0-9]+: '
ip route get 8.8.8.8 || log_warn "Unable to reach external route."

# ---------------------------------------------------------------------------
# 4. Dock / NIC Modules
# ---------------------------------------------------------------------------
log_info "Dock / NIC Modules"
for mod in r8152 ax88179_178a cdc_ncm; do
  if lsmod | grep -q "^${mod}"; then
    log_pass "Module ${mod} loaded."
  else
    log_warn "Module ${mod} not loaded."
  fi
done
sudo dmesg | grep -E 'r8152|ax88179|cdc_ncm|eth' | tail -n 20 || true

# ---------------------------------------------------------------------------
# 5. DisplayLink / EVDI
# ---------------------------------------------------------------------------
log_info "DisplayLink / EVDI Status"
if systemctl is-active --quiet displaylink.service; then
  log_pass "displaylink.service active."
else
  log_warn "displaylink.service inactive."
  systemctl status displaylink.service -n 20 || true
fi

if lsmod | grep -q '^evdi'; then
  log_pass "EVDI module loaded."
else
  log_fail "EVDI module missing."
fi
sudo dmesg | grep -iE 'displaylink|evdi' | tail -n 25 || true

# ---------------------------------------------------------------------------
# 6. DRM devices
# ---------------------------------------------------------------------------
log_info "DRM Devices"
ls /sys/class/drm/ || log_warn "No DRM devices found."
ls -l /dev/dri/ || log_warn "No /dev/dri entries found."

# ---------------------------------------------------------------------------
# 7. Hyprland monitors
# ---------------------------------------------------------------------------
log_info "Hyprland Monitors"
if command -v hyprctl &>/dev/null; then
  hyprctl monitors || log_warn "hyprctl failed ‚Äî Hyprland may not be running."
else
  log_warn "hyprctl not installed."
fi

# ---------------------------------------------------------------------------
# 8. Power management
# ---------------------------------------------------------------------------
log_info "Power Management"
if systemctl is-active --quiet tlp.service; then
  log_pass "tlp.service active."
  sudo tlp-stat -b | grep -E 'Mode|Charge' || true
else
  log_warn "tlp.service inactive."
fi

if systemctl is-active --quiet bolt.service; then
  log_pass "bolt.service active."
  boltctl list || true
else
  log_warn "bolt.service inactive."
fi

# ---------------------------------------------------------------------------
# 9. Sensors
# ---------------------------------------------------------------------------
log_info "Thermal Sensors"
if command -v sensors &>/dev/null; then
  sensors || log_warn "No sensor output detected."
else
  log_warn "sensors command not available."
fi

# ---------------------------------------------------------------------------
# 10. Summary
# ---------------------------------------------------------------------------
log_bar
say "üßæ Summary"
systemctl is-active --quiet displaylink.service && log_pass "DisplayLink OK." || log_fail "DisplayLink inactive."
lsmod | grep -q '^evdi' && log_pass "EVDI loaded." || log_fail "EVDI missing."
systemctl is-active --quiet tlp.service && log_pass "TLP active." || log_warn "TLP inactive."
systemctl is-active --quiet bolt.service && log_pass "BOLT active." || log_warn "BOLT inactive."
log_bar

# ---------------------------------------------------------------------------
# 11. Optional cleanup
# ---------------------------------------------------------------------------
log_info "Sourced 99-post-migration for cleanup."
log_info "üèÅ test-thinkpad completed successfully."
source ./99-post-migration
