#!/usr/bin/env bash
set -euo pipefail

pwd=$(pwd)
cd /tmp
sudo rm -rf evdi

# ğŸ§± Clone EVDI: prefer latest known good tag, else master
EVDI_REPO="https://github.com/DisplayLink/evdi.git"
if git ls-remote --tags "$EVDI_REPO" | grep -q "refs/tags/1.13.1"; then
  echo "ğŸ”¹ Cloning EVDI tag 1.13.1..."
  git clone --depth=1 --branch 1.13.1 "$EVDI_REPO"
else
  echo "âš ï¸  Tag 1.13.1 not found, falling back to master branch..."
  git clone --depth=1 "$EVDI_REPO"
fi

# ğŸ§© Build kernel module only (skip broken library step)
echo "ğŸ”§ Building EVDI kernel module..."
cd evdi/module
make CFLAGS=-Wno-error
sudo make install

# ğŸ§© Load the module and verify
echo "ğŸ”Œ Loading EVDI kernel module..."
sudo modprobe evdi || {
  echo "âŒ modprobe evdi failed â€” check dmesg for details."
  exit 1
}

# ğŸ§© Confirm module load
if lsmod | grep -q '^evdi'; then
  echo "âœ… EVDI module successfully loaded."
else
  echo "âš ï¸  EVDI module not visible in lsmod â€” check kernel logs."
fi

# ğŸ§© Verify DisplayLink service
echo "ğŸ”§ Restarting DisplayLink service..."
sudo systemctl restart displaylink.service || true
systemctl status displaylink.service -n 15 || true

# Restore working directory
cd "$pwd"
echo "ğŸ EVDI build script completed."
