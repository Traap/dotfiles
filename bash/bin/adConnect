#!/usr/bin/env bash
# =====================================================================
# adConnect — Automatic AD reconnect + Passwordless Kerberos + SSSD check
# =====================================================================
set -euo pipefail

# Colors
green()  { printf "\033[1;32m%s\033[0m\n" "$*"; }
yellow() { printf "\033[1;33m%s\033[0m\n" "$*"; }
red()    { printf "\033[1;31m%s\033[0m\n" "$*"; }

info()  { green  "[INFO]  $*"; }
warn()  { yellow "[WARN]  $*"; }
fail()  { red    "[FAIL]  $*"; }

# =====================================================================
# Environment (from /etc/environment.d/27-Traap.conf)
# =====================================================================
: "${AD_USER:?AD_USER not set}"
: "${AD_DOMAIN:?AD_DOMAIN not set}"
: "${AD_DNS1:?AD_DNS1 not set}"
: "${AD_DNS2:?AD_DNS2 not set}"
: "${WIN_DOMAIN:?WIN_DOMAIN not set}"

AD_REALM="${AD_DOMAIN^^}"
AD_LOWER="${AD_DOMAIN,,}"
KEYTAB="$HOME/.config/krb5/user.keytab"

# =====================================================================
# Detect County Network
# =====================================================================
info "Checking AD network ($AD_DNS1)..."
if ping -c1 -W2 "$AD_DNS1" >/dev/null 2>&1; then
    AD_ONLINE=true
    info "County network detected."
else
    AD_ONLINE=false
    warn "County network NOT detected — running in offline mode."
fi

# =====================================================================
# DNS configuration (only when online)
# =====================================================================
if $AD_ONLINE; then
    info "Applying AD DNS configuration..."
    sudo resolvectl dns wlan0 "$AD_DNS1" "$AD_DNS2" || true
    sudo resolvectl domain wlan0 "$AD_LOWER" co.ventura.ca.us || true
fi

# =====================================================================
#  Kerberos login
# =====================================================================
info "Running kinit for $AD_USER@$AD_DOMAIN..."
if kinit "$AD_USER@$AD_DOMAIN"; then
    info "Kerberos ticket acquired."
else
    warn "Kerberos login failed."
fi

# =====================================================================
# Kerberos ticket check
# =====================================================================
info "Current Kerberos tickets:"
klist || warn "No active Kerberos tickets."

# =====================================================================
# AD identity resolution test
# =====================================================================
info "Checking SSSD identity for $WIN_DOMAIN\\$AD_USER..."
if timeout 3 getent passwd "$WIN_DOMAIN\\$AD_USER" >/dev/null; then
    info "SSSD successfully resolved AD user."
else
    warn "SSSD identity lookup failed — may be initializing or offline."
fi

info "adConnect complete."
