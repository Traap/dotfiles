#!/bin/bash
# {{{ Youtube: Demonstrate and checkoff items below.
#
#   1. [-] Open tmux-runner and send compand to run nvims executable script
#   2. [-] Make a choice that is cloned
#   3. [-] Make a choice that is pulled
#   4. [-] Make a choice that does not need to pull
#   5. [-] Code walk through
#   6. [-] Discuss nvim_appnames
#   7. [-] Hook nbvim_apnames into bashrc, aka, my_aliases
#   8. [-] Hook into sxhkd
#
# -- ----------------------------------------------------------------------- }}}
# {{{ Define Neovim applications you want to experiment with.

# Youtube: Review variables controlling output.

# File name that is overwritten with nvim appname aliases.
readonly nvimAppNameFile="$BASHHOME"/nvim_appnames

# nvapp names extracted from neovim_apps array.
nvapps=()

# The repository clonded must bootstrap itself.  In otherwords, clone and nvim
# is all tha tis needed.
#
# alias      | Github repository       | default or branch name
readonly neovim_apps=(
  "astro     | AstroNvim/AstroNvim     | default"
  "default   | none                    | none"
  "kickstart | nvim-lua/kickstart.nvim | default"
  "lazy      | LazyVim/LazyVim         | default"
  "nvchad    | NvChad/NvChad           | default"
  "prime     | Traap/init.lua          | default"
  "starter   | LazyVim/starter         | default"
  "traap     | Traap/nvim              | default"
  "vapour    | Traap/VapourNvim        | default"
  "zulu      | Traap/nvim              | v0.6.8-packer"
  "void      | nvoid-lua/nvoid         | default"
)

# Working directory
dir=$(pwd)

# -------------------------------------------------------------------------- }}}
# {{{ Determine if a pull is needed.

gitcheck() {
  # Git variables used to determine if a pull is needed.
  UPSTREAM=${1:-'@{u}'}
  LOCAL=$(git rev-parse @)
  REMOTE=$(git rev-parse "$UPSTREAM")
  BASE=$(git merge-base @ "$UPSTREAM")

  if [[ "$LOCAL" == "$REMOTE" ]]; then
      echo "Up-to-date"
  elif [[ "$REMOTE" == "$BASE" ]]; then
      echo "Need-to-Push"
  elif [[ "$LOCAL" == "$BASE" ]]; then
      echo "Need-to-Pull"
  else
      echo "Diverged"
  fi
}

# -------------------------------------------------------------------------- }}}
# {{{ Remove all spaces from parameter 1.

removeSpaces() {
  var="$(echo -e "$1" | tr -d '[:space:]')"
  echo "$var"
}

# -------------------------------------------------------------------------- }}}
# {{{ Extract fields from neovim_app array.

buildNeovimAppArray() {
  for fields in "${neovim_apps[@]}"; do
    IFS=$'|' read -r alias _url _branch <<<"$fields"
    alias="$(removeSpaces "$alias")"
    nvapps+=("$alias")
  done
}

# -------------------------------------------------------------------------- }}}
# {{{ Clone or Pull selected nvapp

cloneOrPullNvApp() {
  for fields in "${neovim_apps[@]}"; do
    IFS=$'|' read -r alias url branch <<<"$fields"

    alias="$(removeSpaces "$alias")"
    if [[ "$1" == "$alias" ]]; then
      url="$(removeSpaces "$url")"
      branch="$(removeSpaces "$branch")"
      location=$HOME/.config/$alias
      if [[ -d "$location" ]]; then
        pullRepository "$alias"
      else
        cloneRepository "$alias" "$url" "$branch"
      fi
      return
    fi
  done
}

# -------------------------------------------------------------------------- }}}
# {{{ Pull repository

pullRepository() {
  alias="$1"
  location=$HOME/.config/$alias
  runCommandFromDirectory "$location" "git pull"
}

# -------------------------------------------------------------------------- }}}
# {{{ Clone Repository

cloneRepository() {
  alias="$1"
  url="$2"
  branch="$3"
  location=$HOME/.config/$alias

  # Clear clone depth when a branch is needed.
  if [[ $branch == "default" ]]; then
    git clone --depth 1 https://github.com/"$url" "$location"
  else
    git clone https://github.com/"$url" "$location"
    runCommandFromDirectory "$location" "git checkout $branch"
  fi
}

# -------------------------------------------------------------------------- }}}
# {{{ Run a command from another directory.

runCommandFromDirectory() {
  location="$1"
  command="$2"

  cd "$location" || return

  if [[ "$(runCommandCheck "$command")" == true ]]; then
      echo "$command"
      $command
  fi

  toWorkingDirectory
}

# -------------------------------------------------------------------------- }}}
# {{{ Avoid unnecessary pull commands.

runCommandCheck(){
  command="$1"
  run_command=true

  if [[ "$command" == "git pull" ]]; then
    if [[ "$(gitcheck)" != "Need-to-Pull" ]]; then
      run_command=false
    fi
  fi

  echo "$run_command"
}

# -------------------------------------------------------------------------- }}}
# {{{ Move to working directory.

toWorkingDirectory() {
  cd "$dir" || (echo "Returning to working directory failed." && exit)
}

# -------------------------------------------------------------------------- }}}
# {{{ Write neovim aliases to a file that can be souced.

writeAlisesFile() {
  echo "#!/bin/bash" >"$nvimAppNameFile"
  echo "# NVIM_APPNAME aliases" >>"$nvimAppNameFile"
  for nvapp in "${nvapps[@]}"; do
    if [[ "default" != "$nvapp" ]]; then
      echo alias nvim-"${nvapp,,}"=\"NVIM_APPNAME="$nvapp" nvim\" >>"$nvimAppNameFile"
    fi
  done
}

# -------------------------------------------------------------------------- }}}
# {{{ Select Neovim app to switch to.

selectNeovimApp() {
  config=$(
    printf "%s\n" "${nvapps[@]}" |
      fzf --prompt=" Neovim Config  " \
        --height=20% --layout=reverse --border --exit-0
  )

  if [[ -z $config ]]; then
    echo "Nothing selected"
    return 0
  elif [[ $config == "default" ]]; then
    config=""
  fi
  echo "$config"
}

# -------------------------------------------------------------------------- }}}
# {{{ Main logic

main() {
  buildNeovimAppArray
  writeAlisesFile
  choice="$(selectNeovimApp)"
  cloneOrPullNvApp "$choice"
  NVIM_APPNAME="$choice" nvim "$@"
}

# -------------------------------------------------------------------------- }}}
main "$@"
