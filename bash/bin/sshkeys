#!/bin/bash

sshkeys() {
  local agentName
  local cmpTo

  case "$OSTYPE" in
    msys*)   agentName="/usr/bin/ssh-agent"; cmpTo=0 ;;
    linux*)  agentName="ssh-agent"; cmpTo=1 ;;
    *)       echo "Unsupported OS: $OSTYPE"; return 1 ;;
  esac

  if [[ -d $SSHHOME ]]; then
    if ! pgrep -u "$USER" -x "$(basename "$agentName")" > /dev/null; then
      eval "$(ssh-agent -s)" > /dev/null

      for key in "$SSHHOME"/*.pub; do
        [[ -f "$key" ]] || continue
        ssh-add -q "${key%.*}" 2>/dev/null
      done
    fi
  else
    echo "ERROR: SSHHOME is not defined or not a directory."
  fi
}

sshkeys "$@"
